# 微信小程序登录接口说明

## ✅ 已完成功能

实现了标准的微信小程序登录流程，符合微信官方最佳实践。

## 登录流程

```
┌─────────┐      ┌─────────┐      ┌──────────┐      ┌─────────┐
│  前端   │      │  后端   │      │ 微信服务器 │      │ 数据库   │
└────┬────┘      └────┬────┘      └─────┬────┘      └────┬────┘
     │                │                 │                │
     │ 1. uni.login() │                 │                │
     ├───────────────>│                 │                │
     │   获取 code     │                 │                │
     │<───────────────┤                 │                │
     │                │                 │                │
     │ 2. POST /auth/wechat-login       │                │
     │    { code }    │                 │                │
     ├───────────────>│                 │                │
     │                │ 3. code2session │                │
     │                ├────────────────>│                │
     │                │   返回 openid   │                │
     │                │<────────────────┤                │
     │                │                 │                │
     │                │ 4. 查询用户     │                │
     │                ├────────────────────────────────>│
     │                │   是否存在      │                │
     │                │<────────────────────────────────┤
     │                │                 │                │
     │                │ 5. 不存在则注册  │                │
     │                ├────────────────────────────────>│
     │                │<────────────────────────────────┤
     │                │                 │                │
     │                │ 6. 生成 JWT token                │
     │                │                 │                │
     │ 7. 返回用户信息和token            │                │
     │<───────────────┤                 │                │
     │                │                 │                │
```

## 接口详情

### 1. 微信登录接口

**接口地址**: `POST /auth/wechat-login`

**请求示例**:
```json
{
  "code": "0x1abc2def3ghi"
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "id": 1,
    "userId": 1,
    "username": "wx_abc123def4",
    "nickname": "微信用户_ef123",
    "openid": "oABC123DEF456GHI789JKL",
    "role": "USER",
    "status": 1,
    "token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
    "refreshToken": "eyJ0eXAiOiJKV1QiLCJhbGc..."
  }
}
```

**错误响应**:
```json
{
  "code": 8001,
  "message": "微信登录失败: invalid code",
  "data": null
}
```

## 前端集成示例

### uni-app 示例

```javascript
// 1. 微信登录
async function wechatLogin() {
  try {
    // 调用微信登录获取code
    const loginRes = await uni.login({
      provider: 'weixin'
    });

    if (!loginRes[1] || !loginRes[1].code) {
      uni.showToast({
        title: '获取微信code失败',
        icon: 'none'
      });
      return;
    }

    const code = loginRes[1].code;
    console.log('Got wechat code:', code);

    // 调用后端登录接口
    const res = await uni.request({
      url: 'https://10.10.10.176:8443/auth/wechat-login',
      method: 'POST',
      header: {
        'Content-Type': 'application/json'
      },
      data: {
        code: code
      }
    });

    if (res[1].statusCode === 200 && res[1].data.code === 200) {
      const userData = res[1].data.data;

      // 保存token到本地
      uni.setStorageSync('token', userData.token);
      uni.setStorageSync('refreshToken', userData.refreshToken);
      uni.setStorageSync('userInfo', userData);

      uni.showToast({
        title: '登录成功',
        icon: 'success'
      });

      // 跳转到首页
      uni.switchTab({
        url: '/pages/index/index'
      });
    } else {
      uni.showToast({
        title: res[1].data.message || '登录失败',
        icon: 'none'
      });
    }

  } catch (error) {
    console.error('Login error:', error);
    uni.showToast({
      title: '登录失败，请重试',
      icon: 'none'
    });
  }
}
```

### 在后续请求中使用token

```javascript
// 发送请求时携带token
async function requestWithToken(url, data) {
  const token = uni.getStorageSync('token');

  const res = await uni.request({
    url: 'https://10.10.10.176:8443' + url,
    method: 'POST',
    header: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token  // JWT token
    },
    data: data
  });

  return res[1];
}
```

## 微信API配置

已配置的小程序信息（`application.yml`）:
```yaml
wechat:
  miniapp:
    appid: wx89b6700993f002db
    secret: 820f0350fcac153a725e27839d5a2456
```

## 自动注册规则

当用户首次使用微信登录时，系统会自动创建账号：

| 字段 | 规则 | 示例 |
|------|------|------|
| `openid` | 微信返回的openid | `oABC123DEF456GHI789JKL` |
| `username` | `wx_` + openid后10位 | `wx_789JKL` |
| `nickname` | `微信用户_` + openid后6位 | `微信用户_789JKL` |
| `role` | 固定为 `USER` | `USER` |
| `status` | 固定为 `1`（启用） | `1` |

## 安全特性

1. **Code 一次性**: 微信返回的 code 只能使用一次，5分钟内有效
2. **后端验证**: AppSecret 存储在后端，前端无法伪造
3. **JWT Token**: 使用 JWT 进行后续接口认证
4. **Token 过期**: Access Token 2小时过期，Refresh Token 7天过期

## 常见错误码

| errcode | errmsg | 说明 | 解决方案 |
|---------|--------|------|----------|
| 40029 | invalid code | code无效 | 重新调用uni.login()获取新code |
| 40163 | code been used | code已被使用 | 每次登录使用新的code |
| 45011 | api minute-quota reach limit | 接口调用太频繁 | 限制登录频率 |
| -1 | system error | 系统繁忙 | 稍后重试 |

## 调试建议

### 1. 开发环境
在微信开发者工具中：
- 打开"详情" → "本地设置"
- 勾选"不校验合法域名..."

### 2. 查看日志
```bash
# 后端日志会输出详细信息
tail -f logs/application.log | grep -i wechat
```

### 3. 测试接口
```bash
# 使用curl测试（需要真实的code）
curl -X POST https://10.10.10.176:8443/auth/wechat-login \
  -H "Content-Type: application/json" \
  -d '{"code":"真实的微信code"}'
```

## 与旧接口对比

| 特性 | 旧接口 `/user/login` | 新接口 `/auth/wechat-login` |
|------|---------------------|----------------------------|
| 接收参数 | openid（前端传） | code（微信返回） |
| 安全性 | ❌ 低（可伪造） | ✅ 高（后端验证） |
| 推荐使用 | ❌ 仅用于测试 | ✅ 生产环境使用 |

## 注意事项

1. ⚠️ **AppSecret 安全**: 切勿将 AppSecret 暴露到前端代码中
2. ⚠️ **Code 时效性**: code 获取后应立即使用，不要缓存
3. ⚠️ **用户名唯一性**: 如果openid生成的用户名重复，可能导致注册失败（概率极低）
4. ⚠️ **生产环境**: 确保使用 HTTPS，微信小程序强制要求

## 后续优化建议

1. 支持获取微信用户信息（头像、昵称），需要用户授权
2. 实现 refresh token 刷新机制
3. 添加登录日志记录
4. 实现用户信息更新接口
5. 添加账号绑定功能（手机号、邮箱）
