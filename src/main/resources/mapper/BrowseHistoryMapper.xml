<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dzy.river.chart.luo.writ.mapper.BrowseHistoryMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.dzy.river.chart.luo.writ.domain.entity.BrowseHistory">
        <id column="id" property="id" />
        <result column="content_id" property="contentId" />
        <result column="user_id" property="userId" />
        <result column="browse_count" property="browseCount" />
        <result column="last_browse_time" property="lastBrowseTime" />
        <result column="create_time" property="createTime" />
        <result column="update_time" property="updateTime" />
        <result column="is_deleted" property="isDeleted" />
    </resultMap>

    <!-- 查询用户对某个内容的浏览记录（包括已删除的记录） -->
    <select id="selectByContentIdAndUserId" resultMap="BaseResultMap">
        SELECT * FROM browse_history
        WHERE content_id = #{contentId}
        <choose>
            <when test="userId != null">
                AND user_id = #{userId}
            </when>
            <otherwise>
                AND user_id IS NULL
            </otherwise>
        </choose>
        LIMIT 1
    </select>

    <!-- DTO ResultMap（包含完整的内容信息） -->
    <resultMap id="DTOResultMap" type="com.dzy.river.chart.luo.writ.domain.dto.BrowseHistoryDTO">
        <id column="id" property="id" />
        <result column="content_id" property="contentId" />
        <result column="user_id" property="userId" />
        <result column="browse_count" property="browseCount" />
        <result column="last_browse_time" property="lastBrowseTime" />
        <result column="create_time" property="createTime" />
        <result column="update_time" property="updateTime" />
        <result column="is_deleted" property="isDeleted" />
        <!-- 嵌套ContentDTO -->
        <association property="contentDTO" javaType="com.dzy.river.chart.luo.writ.domain.dto.ContentDTO">
            <id column="c_id" property="id" />
            <result column="c_sub_category_id" property="subCategoryId" />
            <result column="c_title" property="title" />
            <result column="c_content_type" property="contentType" />
            <result column="c_image_url" property="imageUrl" />
            <result column="c_image_thumbnail_url" property="imageThumbnailUrl" />
            <result column="c_image_size" property="imageSize" />
            <result column="c_image_width" property="imageWidth" />
            <result column="c_image_height" property="imageHeight" />
            <result column="c_note_content" property="noteContent" />
            <result column="c_note_format" property="noteFormat" />
            <result column="c_description" property="description" />
            <result column="c_sort_order" property="sortOrder" />
            <result column="c_is_deleted" property="isDeleted" />
            <result column="c_create_time" property="createTime" />
            <result column="c_update_time" property="updateTime" />
        </association>
    </resultMap>

    <!-- 分页查询浏览历史（关联查询完整内容信息，包含已删除内容） -->
    <select id="selectPageWithContentTitle" resultMap="DTOResultMap">
        SELECT
            bh.id,
            bh.content_id,
            bh.user_id,
            bh.browse_count,
            bh.last_browse_time,
            bh.create_time,
            bh.update_time,
            bh.is_deleted,
            c.id AS c_id,
            c.sub_category_id AS c_sub_category_id,
            c.title AS c_title,
            c.content_type AS c_content_type,
            c.image_url AS c_image_url,
            c.image_thumbnail_url AS c_image_thumbnail_url,
            c.image_size AS c_image_size,
            c.image_width AS c_image_width,
            c.image_height AS c_image_height,
            c.note_content AS c_note_content,
            c.note_format AS c_note_format,
            c.description AS c_description,
            c.sort_order AS c_sort_order,
            c.is_deleted AS c_is_deleted,
            c.create_time AS c_create_time,
            c.update_time AS c_update_time
        FROM browse_history bh
        LEFT JOIN content c ON bh.content_id = c.id
        WHERE bh.is_deleted = 0
        <if test="req.userId != null">
            AND bh.user_id = #{req.userId}
        </if>
        <if test="req.contentTitle != null and req.contentTitle != ''">
            AND c.title LIKE CONCAT('%', #{req.contentTitle}, '%')
        </if>
        <if test="req.contentType != null and req.contentType != ''">
            AND c.content_type = #{req.contentType}
        </if>
        <if test="req.startTime != null">
            AND bh.last_browse_time &gt;= #{req.startTime}
        </if>
        <if test="req.endTime != null">
            AND bh.last_browse_time &lt;= #{req.endTime}
        </if>
        ORDER BY bh.last_browse_time DESC
    </select>

</mapper>
